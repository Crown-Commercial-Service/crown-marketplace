<% if flash[:error] && flash[:error].size > 0  %>
<div class="govuk-error-summary">
  <h2 class="govuk-error-summary__title" id="error-summary-title">
    <%= 'There is a problem' %>
  </h2>
  <div class="govuk-error-summary__body">
    <ul class="govuk-list govuk-error-summary__list">
      <% flash[:error].each do |key, value|  %>
      <li>
        <a id="error-summary-link" href="#link_to_services"><%= value %></a>
      </li>
      <% end %>
    </ul>
  </div>
</div>
<% end %>


<div class="govuk-body">
<h1 class="govuk-heading-m">
  <%= t('.heading') %>
  <% content_for :page_title, 'Choose services for your buildings' %>
</h1>
<span id="hint-radio-c" class="govuk-hint govuk-!-font-size-20">
    <%= t('.content_html') %>
  </span>
<div class="content browse">
  <div class="browse-panes section">
    <div id="root" class="pane root-pane">
      <h2 class="govuk-heading-m" tabindex="-1"><%= t('.your_buildings') %></h2>
      <ul>
        <% f.object.active_procurement_buildings.order_by_building_name.each_with_index do |building, i|
            if i == 0 && flash[:error] && flash[:error][building.name]
              use_class = 'active govuk-form-group--error'
            elsif i == 0
              use_class = 'active'
            elsif flash[:error] && flash[:error][building.name]
              use_class = 'govuk-form-group--error'
            end
           %>
          <li class="<%= use_class %>"  >
            <a id="<%= 'building-' + building.id %>" class="building-button govuk-!-font-size-19" href="#"><%= building.name %>
              <strong class="<%= 'building-services-' + building.id %>">(0 selected)</strong></a>
          </li>
        <% end %>
        <li><%= link_to t('.change_buildings'), edit_facilities_management_procurement_path(:step => 'procurement_buildings'), class: "govuk-link--no-visited-state govuk-!-margin-top-2 govuk-!-font-size-19" %></li>
      </ul>
    </div>
    <div id="section" class="section-pane pane with-sort">
      <%= f.fields_for :procurement_buildings, @active_procurement_buildings do |procurement_building| %>
        <% if procurement_building.object.active %>
          <%= procurement_building.hidden_field :name, value: procurement_building.object.name %>
          <div id="<%= 'building-services-' + procurement_building.object.id %>" class="pane-inner services-pane <%= 'hidden-pane' if procurement_building.object.id != f.object.active_procurement_buildings.first.id %>">
            <div class="govuk-form-group <%= 'govuk-form-group--error' if procurement_building.object.errors.any? %>">
              <fieldset class="govuk-fieldset">
              <legend class="govuk-fieldset__legend">
              <h2 tabindex="-1" class="govuk-heading-m govuk-!-margin-top-7">Choose from <%= @services.count %>
                services</h2>
              </legend>
              <%= display_error_no_attr(procurement_building.object, :service_codes) %>
                <% if flash[:error] && flash[:error][procurement_building.object.name] %>
                  <a name="link_to_services"></a>
                  <div class="govuk-error-message govuk-!-margin-top-3">
                    <%= flash[:error][procurement_building.object.name] %>
                  </div>
                <% end %>
              <div class="govuk-checkboxes ccs-govuk-checkboxes--s govuk-checkboxes--small">
                <ul>
                  <%
                    if flash[:selected_services] && flash[:selected_services][procurement_building.object.name]
                       procurement_building.object.service_codes.clear
                       flash[:selected_services][procurement_building.object.name].each { |s| procurement_building.object.service_codes.append(s) }
                     end
                  %>
                  <%= procurement_building.collection_check_boxes(:service_codes, @services, :code, :name) do |c| %>
                    <li class="">
                      <div class="govuk-checkboxes__item">
                        <%= c.check_box(class: "govuk-checkboxes__input procurement-building__input") %>
                        <%= c.label(class: "govuk-label govuk-checkboxes__label") %>
                      </div>
                    </li>
                  <% end %>
                  <li>
                    <div class="govuk-checkboxes__item">
                      <p class="govuk-body govuk-!-margin-bottom-0">or</p>
                    </div>
                  </li>
                  <li class="govuk-checkboxes__item ccs-select-all">
                    <input class="govuk-checkboxes__input box1-all" id="box-all<%= procurement_building.object.id %>" name="box-all" type="checkbox" value="">
                    <label class="govuk-label govuk-checkboxes__label" for="box-all<%= procurement_building.object.id %>">
                      Select all
                    </label>
                  </li>
                  <li class="govuk-checkboxes__item govuk-!-margin-top-5 govuk-!-padding-left-0">
                    <%= link_to '+ Update services', edit_facilities_management_procurement_path(@procurement.id, step: 'services'), class: 'govuk-link govuk-!-font-size-19 update-services' %>
                  </li>
                </ul>
              </div>
              </fieldset>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
<% flash.clear %>
