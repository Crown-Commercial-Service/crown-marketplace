<h3 class="govuk-heading-m govuk-!-margin-bottom-1">About the work</h3>
<table class="govuk-table">
  <tbody class="govuk-table__body">
  <tr class="govuk-table__row" style="border-top:1px solid #ccc; border-bottom:1px solid #ccc;">
    <td class="govuk-!-padding-top-2 govuk-!-padding-bottom-2">
      <table style="width:100%; border-collapse: collapse">
        <tr>
          <td style="width:30%" scope="row" class="govuk-table__header govuk-!-font-size-19 govuk-border-bottom_none <%= 'govuk-!-padding-left-2 govuk-form-group--error' if @procurement.errors[:procurement_buildings].any? %>">
            1. Buildings
          </td>
          <% if @active_procurement_buildings.any? %>
            <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
              <ul class="buildings-list govuk-!-margin-0 govuk-!-padding-top-2 list">
                <% @active_procurement_buildings.each do |procurement_building| %>
                  <li><%= procurement_building.name %></li>
                <% end %>
              </ul>
            </td>
            <td class="govuk-table__cell govuk-border-bottom_none">
              <%= link_to "Change", edit_facilities_management_beta_procurement_path(:step => 'procurement_buildings'), :class => "govuk-link" %>
            </td>
          <% else %>
            <td class="govuk-table__cell govuk-border-bottom_none">
              <%= link_to "Select buildings", edit_facilities_management_beta_procurement_path(:step => 'procurement_buildings'), :class => "govuk-link" %>
            </td>
          <% end %>
        </tr>
        <% if @procurement.errors[:procurement_buildings].any? %>
          <tr class="govuk-table__row govuk-!-margin-0 govuk-!-padding-0 govuk-form-group--error">
            <td class="govuk-!-margin-0 govuk-!-padding-0 govuk-!-padding-left-2 govuk-border-bottom_none" colspan="3"><%= display_error(@procurement, :procurement_buildings, false) %></td>
          </tr>
        <% end %>
      </table>
    </td>
  </tr>
  <tr class="govuk-table__row" style="border-top:1px solid #ccc; border-bottom:1px solid #ccc;">
    <td class="govuk-!-padding-top-2 govuk-!-padding-bottom-2">
      <table style="width:100%; border-collapse: collapse;">
        <tr>
          <td style="width:30%" class="govuk-table__header govuk-!-font-size-19 govuk-border-bottom_none <%= 'govuk-!-padding-left-2 govuk-form-group--error' if @procurement.errors[:base].any? && @active_procurement_buildings.first.service_codes.empty?%>">
            2. Services
          </td>
          <% if @active_procurement_buildings.any? %>
            <% if any_service_codes(@active_procurement_buildings) %>
              <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
                <% @active_procurement_buildings[0..0].each do |procurement_building| %>
                  <%= render 'procurement_building_services', procurement_building: procurement_building %>
                <% end %>
              </td>
              <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
                <%= link_to "Change", edit_facilities_management_beta_procurement_path(:step => 'building_services'), :class => "govuk-link" %>
              </td>
            <% else %>
              <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
                <%= link_to "Select services", edit_facilities_management_beta_procurement_path(:step => 'building_services'), :class => "govuk-link" %>
              </td>
              <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
              </td>
            <% end %>
          <% else %>
            <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
              You must select buildings first
            </td>
            <td style="width:45%" class="govuk-table__cell govuk-border-bottom_none">
              <strong class="govuk-tag">
                CAN'T START YET
              </strong>
            </td>
          <% end %>
        </tr>
        <% if @active_procurement_buildings.first&.service_codes.empty? && @procurement.errors[:service_codes].any? %>
          <tr class="govuk-table__row govuk-!-margin-0 govuk-!-padding-0 <%= 'govuk-form-group--error' if procurement_building.service_codes.empty? %>">
            <td class="govuk-!-margin-0 govuk-!-padding-0 govuk-!-padding-left-2" colspan="3">
                    <span class="govuk-error-message">
                      <%= "You must select at least one service for '#{procurement_building.name}' building." %>
                    </span>
            </td>
          </tr>
        <%end %>
        <% if @active_procurement_buildings.length > 1 %>
          <% @active_procurement_buildings.drop(1).each do |procurement_building| %>
            <tr>
              <td colspan="3" class="govuk-!-padding-top-2 govuk-!-padding-bottom-2">
                <table style="border-collapse: collapse; width:100%">
                  <tr>
                    <td style="width:30%" class="<%= 'govuk-!-padding-left-2 govuk-form-group--error' if procurement_building.service_codes.empty? && procurement_building.errors[:service_codes].any?%>">&nbsp;</td>
                    <td style="width:45%">
                      <%= render 'procurement_building_services', procurement_building: procurement_building %>
                    </td>
                    <td>
                    </td>
                  </tr>
                  <% if procurement_building.service_codes.empty? && procurement_building.errors[:service_codes].any? %>
                    <tr class="govuk-table__row govuk-!-margin-0 govuk-!-padding-0 <%= 'govuk-form-group--error' if procurement_building.service_codes.empty? %>">
                      <td class="govuk-!-margin-0 govuk-!-padding-0 govuk-!-padding-left-2" colspan="3">
                      <span class="govuk-error-message">
                        <%= display_error(procurement_building, :service_codes, false, procurement_building.id) %>
                      </span>
                      </td>
                    </tr>
                  <%end %>
                </table>
              </td>
            </tr>
          <%end %>
        <%end %>
      </table>
    </td>
  </tr>
  <tr class="govuk-table__row" style="border-top:1px solid #ccc; border-bottom:1px solid #ccc;">
    <td class="govuk-!-padding-top-2 govuk-!-padding-bottom-2">
      <table style="width:100%; border-collapse: collapse">
        <tr>
          <td style="width:30%" <%= 'colspan=3 style="border:0 width=30%"' if (@active_procurement_buildings.requires_service_information.length > 0) %> class="govuk-table__header govuk-border-bottom_none govuk-!-font-size-19">
            3. Services information
            <% if any_service_codes(@active_procurement_buildings) %>
              <% if @active_procurement_buildings.requires_service_information.length > 0 %>
                <span id="event-name-hint" class="govuk-hint">
                  We need additional information. You only need to answer questions related to the buildings listed below.
                </span>
              <% end %>
            <% end %>
          </td>
          <% if any_service_codes(@active_procurement_buildings) %>
            <% if (@active_procurement_buildings.requires_service_information.length > 0) %>
              </tr>
              <tr class="govuk-table__row">
              <td class="govuk-table__cell">

              </td>
              <td class="govuk-table__cell">
                <strong>Buildings</strong>
              </td>
              <td class="govuk-table__cell">
                <strong>Status</strong>
              </td>
            </tr>
            <% else %>
                <td class="govuk-table__cell">
                  No additional information needed
                </td>
                <td class="govuk-table__cell">
                </td>
              </tr>
          <% end %>
        <% end %>
        <% if any_service_codes(@active_procurement_buildings) %>
          <% @active_procurement_buildings.requires_service_information.each do |procurement_building| %>
            <tr class="govuk-table__row govuk-no-border <%= 'govuk-form-group--error' if !procurement_building.valid?(:procurement_building_services) && params[:validate] %>">
              <td class="govuk-table__cell">
              </td>
              <td class="govuk-table__cell">
                <p class="govuk-!-padding-0 govuk-!-margin-0 govuk-!-margin-top-3 govuk-!-margin-bottom-3"><%= link_to procurement_building.name, facilities_management_beta_procurement_building_path(procurement_building) %></p>
              </td>
              <td class="govuk-table__cell">
                <p class="govuk-!-padding-0 govuk-!-margin-0 govuk-!-margin-top-3 govuk-!-margin-bottom-3"><%= building_services_status? procurement_building.valid?(:procurement_building_services) %></p>
              </td>
            </tr>
            <% if procurement_building.errors.any? && params[:validate] %>
              <tr class="govuk-table__row govuk-!-margin-0 govuk-!-padding-0 govuk-form-group--error govuk-no-border">
                <td class="govuk-table__cell govuk-!-margin-0 govuk-!-padding-0 govuk-!-padding-left-2 " colspan="3">
                  <%= display_error(@procurement, :procurement_buildings, false) %>
                  <span id="<%= procurement_building.id %>" class="govuk-error-message govuk-!-margin-bottom-0"><%= t('activerecord.errors.models.facilities_management/procurement.attributes.procurement_building_services.invalid_html', building_name: procurement_building.name) %></span>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </table>
    </td>
  </tr>
  </tbody>
</table>

